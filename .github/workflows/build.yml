name: Build OpenDSD GUI

on: [push, pull_request]

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest]

    steps:
    - uses: actions/checkout@v3

    # --- 1. Instalacja zależności systemowych (Linux) ---
    - name: Install System Deps (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake libasound2-dev libgl1-mesa-dev xorg-dev libxi-dev libxcursor-dev libxrandr-dev

    # --- 2. Instalacja mbelib (Budujemy ręcznie, tak jak Ty lokalnie) ---
    - name: Build & Install mbelib
      run: |
        git clone https://github.com/szechyjs/mbelib.git
        cd mbelib
        mkdir build && cd build
        cmake -DCMAKE_INSTALL_PREFIX=/usr/local ..
        make
        sudo make install

    # --- 3. Instalacja dsdcc (Ten konkretny commit!) ---
    - name: Build & Install dsdcc
      run: |
        git clone https://github.com/f4exb/dsdcc.git
        cd dsdcc
        git checkout f27b32d2df131ae3a376fe72d3fb880ae1f9ede1
        mkdir build && cd build
        cmake -DCMAKE_INSTALL_PREFIX=/usr/local -DUSE_MBELIB=ON ..
        make
        sudo make install

    # --- 4. Pobranie miniaudio.h (jeśli nie ma go w repo) ---
    - name: Download miniaudio.h
      run: |
        # Sprawdzamy czy plik istnieje, jak nie to pobieramy
        if [ ! -f src/miniaudio.h ]; then
          curl -o src/miniaudio.h https://raw.githubusercontent.com/mackron/miniaudio/master/miniaudio.h
        fi

    # --- 5. Budowanie Twojej Aplikacji ---
    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build Application
      run: cmake --build build --config Release

    # --- 6. Pakowanie wyniku ---
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: OpenDSD_GUI-${{ matrix.os }}
        path: |
          build/OpenDSD_GUI
          build/OpenDSD_GUI.exe